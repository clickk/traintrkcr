/**
 * Full rail corridor geometry — Main North Line (Down Main North)
 *
 * ~20 km of track from south of Fassifern through Cardiff, Kotara,
 * Broadmeadow to Hamilton. Sourced from OpenStreetMap.
 * Data © OpenStreetMap contributors, ODbL.
 *
 * Ways stitched (south → north):
 * 432724777, 432724774, 172752350, 32060278, [gap bridge],
 * 32060266, 31729535, 31729538, 172657336, 432724772,
 * [gap bridge], 432724771, 432724768, 174265326,
 * 173241836, 1086583989, 428893580, 260401801, 260401804,
 * 260401802, 260401803, 432724764
 */

export const RAIL_PATH: [number, number][] = [
  // ── Way 432724777: Far south approach (Fassifern area) ───────────────
  [-32.9615366, 151.6050301],
  [-32.9612633, 151.6054425],
  [-32.9609638, 151.6058417],
  [-32.9605142, 151.6063671],
  [-32.9600766, 151.6068267],
  [-32.9597808, 151.6071225],
  [-32.9593379, 151.6075266],
  [-32.9588500, 151.6079406],
  [-32.9582516, 151.6084017],
  [-32.9577917, 151.6087253],
  [-32.9571921, 151.6090781],
  [-32.9556451, 151.6099359],
  [-32.9536042, 151.6109997],
  [-32.9513381, 151.6120370],
  [-32.9494860, 151.6130260],
  [-32.9476725, 151.6140947],

  // ── Way 432724774: Through Booragul / Teralba ───────────────────────
  [-32.9470241, 151.6144405],
  [-32.9466832, 151.6146531],
  [-32.9460734, 151.6150997],
  [-32.9454996, 151.6156286],
  [-32.9449937, 151.6161997],
  [-32.9445648, 151.6167890],
  [-32.9441538, 151.6174810],
  [-32.9439778, 151.6178353],
  [-32.9436673, 151.6185771],
  [-32.9435399, 151.6189456],
  [-32.9433737, 151.6195199],
  [-32.9432593, 151.6200749],
  [-32.9431859, 151.6205045],

  // ── Way 172752350: Bridge ────────────────────────────────────────────
  [-32.9431284, 151.6208578],
  [-32.9429025, 151.6223109],

  // ── Way 32060278: Through West Wallsend / Barnsley area ─────────────
  [-32.9427802, 151.6231289],
  [-32.9426815, 151.6236968],
  [-32.9425611, 151.6242489],
  [-32.9424724, 151.6245700],
  [-32.9423313, 151.6250201],
  [-32.9421655, 151.6254645],
  [-32.9419746, 151.6259001],
  [-32.9417044, 151.6264279],
  [-32.9413780, 151.6269654],
  [-32.9410905, 151.6273781],
  [-32.9409240, 151.6276064],
  [-32.9402047, 151.6285580],
  [-32.9394424, 151.6295754],
  [-32.9389777, 151.6301882],
  [-32.9382835, 151.6311310],
  [-32.9379742, 151.6316129],
  [-32.9377073, 151.6321039],
  [-32.9374837, 151.6325783],
  [-32.9372419, 151.6331873],
  [-32.9370825, 151.6336935],
  [-32.9369481, 151.6342168],
  [-32.9368453, 151.6347485],
  [-32.9367740, 151.6352786],
  [-32.9367297, 151.6358167],
  [-32.9367181, 151.6361840],
  [-32.9367224, 151.6366693],
  [-32.9368134, 151.6379262],
  [-32.9369478, 151.6395330],

  // ── Gap bridge: Fassifern (interpolated) ─────────────────────────────
  [-32.9369700, 151.6420000],
  [-32.9369900, 151.6450000],
  [-32.9370200, 151.6480000],
  [-32.9370800, 151.6510000],
  [-32.9371200, 151.6535000],

  // ── Way 32060266: Bridge ─────────────────────────────────────────────
  [-32.9371585, 151.6551725],
  [-32.9370177, 151.6554275],

  // ── Way 31729535: Adamstown South approach ───────────────────────────
  [-32.9367083, 151.6559520],
  [-32.9365386, 151.6563125],
  [-32.9364010, 151.6566533],
  [-32.9363040, 151.6569565],
  [-32.9362433, 151.6572155],

  // ── Way 31729538: Bridge ─────────────────────────────────────────────
  [-32.9361830, 151.6575302],

  // ── Way 172657336: Through Adamstown ─────────────────────────────────
  [-32.9361544, 151.6577737],
  [-32.9361364, 151.6581801],
  [-32.9361519, 151.6585608],
  [-32.9361974, 151.6589405],
  [-32.9362762, 151.6593042],
  [-32.9363827, 151.6596586],
  [-32.9365159, 151.6599979],
  [-32.9366754, 151.6603248],
  [-32.9368686, 151.6606232],
  [-32.9370964, 151.6609345],
  [-32.9373080, 151.6611626],
  [-32.9375514, 151.6613862],
  [-32.9378050, 151.6615703],
  [-32.9380859, 151.6617377],
  [-32.9383268, 151.6618529],
  [-32.9386281, 151.6619571],
  [-32.9389206, 151.6620304],
  [-32.9394299, 151.6621191],
  [-32.9398255, 151.6621685],

  // ── Way 432724772: Approach to Cardiff ───────────────────────────────
  [-32.9407694, 151.6623963],
  [-32.9410104, 151.6625023],
  [-32.9412751, 151.6626455],
  [-32.9415315, 151.6628196],
  [-32.9420590, 151.6632171],
  [-32.9423882, 151.6634937],

  // ── Gap bridge to Cardiff (interpolated) ─────────────────────────────
  [-32.9427000, 151.6645000],
  [-32.9430000, 151.6656000],

  // ── Way 432724771: CARDIFF STATION area ──────────────────────────────
  [-32.9434264, 151.6668132],
  [-32.9432879, 151.6681841],   // ← CARDIFF STATION (on-track)
  [-32.9432281, 151.6687582],
  [-32.9431949, 151.6690146],
  [-32.9431621, 151.6692311],
  [-32.9431287, 151.6693889],
  [-32.9430827, 151.6695713],
  [-32.9430198, 151.6697686],
  [-32.9429572, 151.6699479],
  [-32.9428732, 151.6701370],
  [-32.9427803, 151.6703301],
  [-32.9426547, 151.6705431],
  [-32.9425748, 151.6706729],
  [-32.9424059, 151.6708960],
  [-32.9422577, 151.6710587],
  [-32.9421347, 151.6711815],
  [-32.9419884, 151.6713172],
  [-32.9417590, 151.6715059],
  [-32.9412598, 151.6718906],
  [-32.9411714, 151.6719625],
  [-32.9410026, 151.6721046],
  [-32.9408704, 151.6722257],
  [-32.9407153, 151.6723847],
  [-32.9406249, 151.6724923],
  [-32.9404923, 151.6726653],
  [-32.9403706, 151.6728459],
  [-32.9402229, 151.6731053],
  [-32.9401401, 151.6732790],
  [-32.9400604, 151.6734689],
  [-32.9399925, 151.6736631],
  [-32.9399389, 151.6738474],
  [-32.9398549, 151.6742141],
  [-32.9397921, 151.6746177],

  // ── Way 432724768: Mid-corridor curve ────────────────────────────────
  [-32.9394362, 151.6773407],
  [-32.9393791, 151.6778491],
  [-32.9393529, 151.6783692],
  [-32.9393586, 151.6788311],
  [-32.9393908, 151.6793428],
  [-32.9394574, 151.6798127],
  [-32.9395486, 151.6802978],
  [-32.9396612, 151.6807431],
  [-32.9398132, 151.6812140],
  [-32.9400007, 151.6816865],
  [-32.9401106, 151.6819303],
  [-32.9401952, 151.6820975],
  [-32.9403370, 151.6823614],
  [-32.9404302, 151.6825208],
  [-32.9406727, 151.6828957],
  [-32.9409575, 151.6832934],
  [-32.9412683, 151.6836761],
  [-32.9421366, 151.6845923],
  [-32.9432321, 151.6857501],
  [-32.9435605, 151.6861066],

  // ── Way 174265326: Tickhole Tunnel ───────────────────────────────────
  [-32.9439694, 151.6866098],
  [-32.9441074, 151.6868663],
  [-32.9442141, 151.6871027],
  [-32.9443963, 151.6875990],

  // ── Way 173241836: Approach to Kotara ────────────────────────────────
  [-32.9444378, 151.6877591],
  [-32.9445233, 151.6880880],
  [-32.9445870, 151.6884115],
  [-32.9446326, 151.6887393],
  [-32.9446590, 151.6890490],
  [-32.9446713, 151.6893257],
  [-32.9446702, 151.6896357],
  [-32.9446427, 151.6899986],
  [-32.9445880, 151.6903892],
  [-32.9444858, 151.6908285],
  [-32.9443981, 151.6911379],
  [-32.9442243, 151.6915878],
  [-32.9440490, 151.6919552],   // ← USER WATCH POINT (closest track pt)
  [-32.9437356, 151.6925028],
  [-32.9435133, 151.6928540],
  [-32.9430307, 151.6936559],
  [-32.9427839, 151.6941147],
  [-32.9427020, 151.6943088],

  // ── Way 1086583989: KOTARA STATION area ──────────────────────────────
  [-32.9425605, 151.6946441],
  [-32.9424125, 151.6950622],   // ← KOTARA STATION (on-track)
  [-32.9423404, 151.6952890],
  [-32.9422332, 151.6956487],
  [-32.9421263, 151.6960218],
  [-32.9419355, 151.6966805],
  [-32.9418716, 151.6969005],
  [-32.9417591, 151.6972478],
  [-32.9415173, 151.6978930],
  [-32.9414025, 151.6982145],
  [-32.9413091, 151.6985301],
  [-32.9412660, 151.6986943],
  [-32.9412176, 151.6989054],
  [-32.9411431, 151.6992998],
  [-32.9410682, 151.6996555],
  [-32.9409954, 151.6999791],
  [-32.9409176, 151.7002734],
  [-32.9408924, 151.7003672],

  // ── Way 428893580: Broadmeadow approach ──────────────────────────────
  [-32.9404089, 151.7020874],
  [-32.9402146, 151.7027231],
  [-32.9400786, 151.7031211],
  [-32.9398207, 151.7038162],
  [-32.9395141, 151.7045459],
  [-32.9392003, 151.7052053],
  [-32.9379301, 151.7077195],
  [-32.9375238, 151.7085084],
  [-32.9370014, 151.7095368],
  [-32.9368449, 151.7098704],
  [-32.9366625, 151.7102830],
  [-32.9364822, 151.7107613],
  [-32.9363940, 151.7110311],
  [-32.9363103, 151.7112996],

  // ── Way 260401801 + 260401804: Bridges + Broadmeadow ────────────────
  [-32.9361711, 151.7118546],
  [-32.9361138, 151.7121168],
  [-32.9360760, 151.7123069],
  [-32.9359370, 151.7131409],
  [-32.9358892, 151.7135036],
  [-32.9358223, 151.7141544],
  [-32.9357912, 151.7145243],

  // ── Way 260401802 + 260401803: Broadmeadow → Hamilton ────────────────
  [-32.9357735, 151.7147540],
  [-32.9357646, 151.7148706],
  [-32.9356943, 151.7155550],
  [-32.9355946, 151.7161631],
  [-32.9354292, 151.7168471],
  [-32.9353158, 151.7172163],
  [-32.9351273, 151.7177289],
  [-32.9349894, 151.7180559],
  [-32.9347537, 151.7185289],
  [-32.9345150, 151.7189428],
  [-32.9343242, 151.7192374],
  [-32.9340315, 151.7196546],
  [-32.9335080, 151.7203645],
  [-32.9333416, 151.7205945],
  [-32.9329872, 151.7210671],
  [-32.9326332, 151.7215493],
  [-32.9322338, 151.7221040],
  [-32.9311814, 151.7237480],
  [-32.9302277, 151.7252597],
  [-32.9298867, 151.7257760],
  [-32.9295276, 151.7262856],
  [-32.9292062, 151.7267185],
  [-32.9277585, 151.7286826],
  [-32.9267924, 151.7299849],
  [-32.9262992, 151.7306008],
  [-32.9256348, 151.7313144],
  [-32.9252448, 151.7317357],
  [-32.9248913, 151.7321218],
  [-32.9245791, 151.7324829],
  [-32.9241480, 151.7330521],
  [-32.9238508, 151.7334464],

  // ── Way 432724764: Hamilton ──────────────────────────────────────────
  [-32.9235348, 151.7338806],
  [-32.9224786, 151.7353101],
  [-32.9218379, 151.7361772],
  [-32.9212651, 151.7369566],
  [-32.9208432, 151.7375235],
  [-32.9206428, 151.7378042],
];

// ─── Key location indices ───────────────────────────────────────────────────
// Found by matching coordinates in the path above.

/** Cardiff station: [-32.9432879, 151.6681841] */
export const CARDIFF_PATH_INDEX = findNearest(-32.9432879, 151.6681841);

/** User watch point: 32°56'38.6"S 151°41'30.9"E = [-32.9441, 151.6919] */
export const WATCH_POINT_PATH_INDEX = findNearest(-32.9440490, 151.6919552);

/** Kotara station: [-32.9424, 151.6951] */
export const KOTARA_PATH_INDEX = findNearest(-32.9424125, 151.6950622);

// ─── On-track positions ─────────────────────────────────────────────────────

export const CARDIFF_TRACK_POS: [number, number] = RAIL_PATH[CARDIFF_PATH_INDEX];
export const WATCH_POINT_TRACK_POS: [number, number] = RAIL_PATH[WATCH_POINT_PATH_INDEX];
export const KOTARA_TRACK_POS: [number, number] = RAIL_PATH[KOTARA_PATH_INDEX];

// ─── Path math ──────────────────────────────────────────────────────────────

function findNearest(lat: number, lng: number): number {
  let best = 0;
  let bestDist = Infinity;
  for (let i = 0; i < RAIL_PATH.length; i++) {
    const d = (RAIL_PATH[i][0] - lat) ** 2 + (RAIL_PATH[i][1] - lng) ** 2;
    if (d < bestDist) { bestDist = d; best = i; }
  }
  return best;
}

function computeCumulativeDistances(path: [number, number][]): number[] {
  const d = [0];
  for (let i = 1; i < path.length; i++) {
    const dx = path[i][0] - path[i - 1][0];
    const dy = path[i][1] - path[i - 1][1];
    d.push(d[i - 1] + Math.sqrt(dx * dx + dy * dy));
  }
  return d;
}

const CUMULATIVE = computeCumulativeDistances(RAIL_PATH);

export const TOTAL_PATH_LENGTH = CUMULATIVE[CUMULATIVE.length - 1];
export const CARDIFF_DISTANCE = CUMULATIVE[CARDIFF_PATH_INDEX];
export const WATCH_POINT_DISTANCE = CUMULATIVE[WATCH_POINT_PATH_INDEX];
export const KOTARA_DISTANCE = CUMULATIVE[KOTARA_PATH_INDEX];

/**
 * Interpolate a position along the rail path.
 * @param t — normalised 0..1 over the full path length
 */
export function interpolateOnPath(t: number): [number, number] {
  const clamped = Math.max(0, Math.min(1, t));
  const target = clamped * TOTAL_PATH_LENGTH;
  for (let i = 1; i < CUMULATIVE.length; i++) {
    if (CUMULATIVE[i] >= target) {
      const s = CUMULATIVE[i - 1];
      const e = CUMULATIVE[i];
      const f = e === s ? 0 : (target - s) / (e - s);
      const [a, b] = RAIL_PATH[i - 1];
      const [c, d] = RAIL_PATH[i];
      return [a + (c - a) * f, b + (d - b) * f];
    }
  }
  return RAIL_PATH[RAIL_PATH.length - 1];
}
